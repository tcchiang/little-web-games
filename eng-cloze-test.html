<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯æ„›è‹±æ–‡å¡«ç©ºå°æ¸¬é©—</title>
  <style>
    :root{
      --bg:#fff7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --accent:#ff6fb1;
      --accent2:#7cddff;
      --good:#16a34a;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 22px;
      --border: 2px solid rgba(255,111,177,.25);
      --font: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(255,111,177,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(124,221,255,.20), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(255,206,84,.18), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding:24px 14px 60px;
    }
    .wrap{max-width:980px;margin:0 auto}

    header{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:18px;
    }
    .title{display:flex;gap:12px;align-items:center}
    .logo{
      width:54px;height:54px;border-radius:16px;
      background: linear-gradient(135deg, rgba(255,111,177,.95), rgba(124,221,255,.9));
      box-shadow: var(--shadow);
      position:relative;
      border:2px solid rgba(255,255,255,.65);
    }
    .logo:before,.logo:after{content:"";position:absolute;border-radius:50%;background:rgba(255,255,255,.9);top:18px;width:9px;height:9px;}
    .logo:before{left:16px}
    .logo:after{right:16px}
    .logo i{position:absolute;left:50%;top:34px;transform:translateX(-50%);width:18px;height:8px;border:2px solid rgba(255,255,255,.95);border-top:0;border-radius:0 0 14px 14px;}

    h1{margin:0;font-size:clamp(20px, 3.6vw, 30px);line-height:1.15}
    .subtitle{margin:4px 0 0;color:var(--muted);font-size:14px}

    .pillbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.06);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      display:flex;gap:10px;align-items:center;
      font-size:14px;
    }
    .pill b{font-variant-numeric: tabular-nums}

    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:16px;}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}

    .card{
      background:rgba(255,255,255,.92);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 18px;
      border-bottom:1px dashed rgba(255,111,177,.35);
      background: linear-gradient(90deg, rgba(255,111,177,.12), rgba(124,221,255,.12));
    }
    .card .bd{padding:18px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,111,177,.95), rgba(255,153,98,.92));
      color:white;font-weight:700;
      box-shadow: 0 10px 18px rgba(255,111,177,.25);
      transition: transform .08s ease, filter .2s ease;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn:active{transform: translateY(1px)}

    .btn2{
      appearance:none;border:0;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      background: rgba(124,221,255,.55);
      color:#0b3a4a;font-weight:700;
      box-shadow: 0 10px 18px rgba(124,221,255,.18);
    }

    .file{padding:10px 12px;border-radius:14px;border: 2px dashed rgba(255,111,177,.38);background: rgba(255,255,255,.7);}

    .qno{font-weight:800;color:#ff4c9a}
    .qtext{
      margin-top:10px;
      padding:14px 14px;
      border: var(--border);
      background: rgba(255,247,251,.8);
      border-radius: 18px;
      font-size:18px;
      line-height:1.45;
    }

    .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    @media (max-width:520px){.choices{grid-template-columns:1fr}}

    .choice{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:16px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.88);
      cursor:pointer;
      font-weight:700;
      display:flex;gap:10px;align-items:center;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .choice:hover{transform: translateY(-1px);border-color: rgba(255,111,177,.5)}
    .badge{width:30px;height:30px;border-radius:12px;display:grid;place-items:center;background: rgba(255,111,177,.16);color:#ff4c9a;font-weight:900;border:1px solid rgba(255,111,177,.25);flex:0 0 auto;}

    .choice[disabled]{cursor:not-allowed;opacity:.85}
    .choice.correct{border-color: rgba(22,163,74,.5); background: rgba(22,163,74,.10)}
    .choice.wrong{border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.10)}

    /* cute animations */
    @keyframes pop { 0%{transform:scale(.98)} 60%{transform:scale(1.02)} 100%{transform:scale(1)} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
    @keyframes glow { 0%{box-shadow: var(--shadow)} 50%{box-shadow: 0 14px 40px rgba(255,111,177,.20)} 100%{box-shadow: var(--shadow)} }
    .pop{animation: pop .22s ease}
    .shake{animation: shake .28s ease}
    .glow{animation: glow .6s ease}

    .feedback{margin-top:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(0,0,0,.08);background: rgba(255,255,255,.85);display:flex;align-items:center;gap:10px;min-height:46px;}
    .dot{width:12px;height:12px;border-radius:50%;background: rgba(107,114,128,.5);box-shadow: 0 0 0 6px rgba(107,114,128,.14);}
    .dot.good{background: rgba(22,163,74,.95); box-shadow:0 0 0 6px rgba(22,163,74,.14)}
    .dot.bad{background: rgba(239,68,68,.95); box-shadow:0 0 0 6px rgba(239,68,68,.14)}

    .muted{color:var(--muted);font-size:13px;line-height:1.45}

    .side .bd{padding:16px}
    .stat{display:grid;gap:10px;grid-template-columns: 1fr 1fr;}
    .box{padding:12px 12px;border-radius:18px;background: rgba(255,247,251,.85);border: 1px solid rgba(255,111,177,.22);}
    .box b{display:block;font-size:20px;font-variant-numeric: tabular-nums}
    .box span{color:var(--muted);font-size:12px}

    .progress{height:14px;border-radius:999px;background: rgba(0,0,0,.06);overflow:hidden;border:1px solid rgba(0,0,0,.06);}
    .bar{height:100%;width:0%;background: linear-gradient(90deg, rgba(255,111,177,.95), rgba(124,221,255,.92));transition: width .25s ease;}

    .tiny{font-size:12px;color:var(--muted)}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;padding:2px 6px;border-radius:8px;background: rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.08);}

    footer{margin-top:16px;color:var(--muted);font-size:12px;text-align:center}

    /* finish overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(31,41,55,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
      backdrop-filter: blur(2px);
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.94);
      box-shadow: 0 18px 50px rgba(0,0,0,.20);
      border: 1px solid rgba(0,0,0,.08);
      overflow:hidden;
      transform: translateY(6px);
      animation: pop .22s ease;
      position:relative;
    }
    .modal .mh{
      padding:16px 18px;
      background: linear-gradient(90deg, rgba(255,111,177,.16), rgba(124,221,255,.16));
      border-bottom:1px dashed rgba(255,111,177,.35);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal .mb{padding:18px}
    .stars{font-size:26px; letter-spacing:2px}
    .big{font-size:22px; font-weight:900; margin:4px 0 0}
    .sub{color:var(--muted); margin-top:6px; line-height:1.5}
    .modal .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:14px}
    .chip{
      border-radius:18px;
      background: rgba(255,247,251,.90);
      border: 1px solid rgba(255,111,177,.22);
      padding:12px 12px;
    }
    .chip b{display:block; font-size:20px; font-variant-numeric: tabular-nums}
    .chip span{color:var(--muted); font-size:12px}

    .emojiRain{
      position:absolute; inset:0; pointer-events:none; overflow:hidden;
    }
    .emoji{
      position:absolute;
      top:-20px;
      font-size:22px;
      opacity:.95;
      animation: fall 1.6s linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.12));
    }
    @keyframes fall{
      to{ transform: translateY(calc(100vh + 60px)) rotate(210deg); opacity:.98; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"><i></i></div>
        <div>
          <h1>å¯æ„›è‹±æ–‡å¡«ç©ºå°æ¸¬é©—</h1>
          <div class="subtitle">è®€å–æ–‡å­—æª” â†’ é€é¡Œä½œç­” â†’ ç«‹å³è¨˜åˆ† âœ¨</div>
        </div>
      </div>
      <div class="pillbar">
        <div class="pill">â³ å€’æ•¸ <b id="pillTimer">--</b></div>
        <div class="pill">ğŸŒŸ é€²åº¦ <b id="pillProgress">0/0</b></div>
        <div class="pill">âœ… ç­”å° <b id="pillCorrect">0</b></div>
        <div class="pill">ğŸ”¥ é€£å° <b id="pillCombo">0</b>ï½œğŸ† æœ€é«˜ <b id="pillMaxCombo">0</b></div>
        <div class="pill">ğŸ§¸ å°æé†’ï¼šæŒ‰ <span class="kbd">N</span> ä¸‹ä¸€é¡Œ</div>
      </div>
    </header>

    <div class="grid">
      <section class="card main">
        <div class="hd">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <label class="file">
                ğŸ“„ è¼‰å…¥é¡Œç›®æª”ï¼š
                <input id="fileInput" type="file" accept=".txt" />
              </label>
              <button class="btn2" id="demoBtn" title="è¼‰å…¥å…§å»ºç¤ºç¯„é¡Œç›®">è¼‰å…¥ç¤ºç¯„</button>
              <label class="file" title="æ¯é¡Œå€’æ•¸ç§’æ•¸">
                â±ï¸ æ¯é¡Œ
                <select id="timeSelect">
                  <option value="10">10 ç§’</option>
                  <option value="15" selected>15 ç§’</option>
                  <option value="20">20 ç§’</option>
                  <option value="30">30 ç§’</option>
                  <option value="0">ä¸è¨ˆæ™‚</option>
                </select>
              </label>
              <label class="file" title="éŸ³æ•ˆé–‹é—œ">
                ğŸ”Š éŸ³æ•ˆ
                <input id="soundToggle" type="checkbox" checked />
              </label>
              <label class="file" title="è‡ªå‹•è·³åˆ°ä¸‹ä¸€é¡Œ">
                â¡ï¸ è‡ªå‹•ä¸‹ä¸€é¡Œ
                <input id="autoNextToggle" type="checkbox" checked />
              </label>
            </div>
            <div class="row">
              <button class="btn" id="restartBtn" disabled>é‡æ–°é–‹å§‹</button>
            </div>
          </div>
          <div class="muted" style="margin-top:10px">
            æª”æ¡ˆæ ¼å¼ï¼šæ¯é¡ŒåŒ…å«ã€Œé¡Œç›®å¥å­ã€ä¸€è¡Œï¼Œä¸‹ä¸€è¡Œæ˜¯ <b>3ï½4</b> å€‹é¸é …ä»¥é€—è™Ÿåˆ†éš”ï¼›æ­£ç¢ºç­”æ¡ˆå‰é¢åŠ  <span class="kbd">*</span>ã€‚
          </div>
        </div>

        <div class="bd">
          <div class="qno" id="qNo">å°šæœªè¼‰å…¥é¡Œç›®</div>
          <div class="qtext" id="qText">è«‹å…ˆé¸æ“‡ä¸€å€‹ .txt é¡Œç›®æª”ï¼Œæˆ–æŒ‰ã€Œè¼‰å…¥ç¤ºç¯„ã€ã€‚</div>

          <div class="choices" id="choices"></div>

          <div class="feedback" id="feedback">
            <div class="dot" id="dot"></div>
            <div id="fbText" class="muted">æº–å‚™å¥½äº†å°±é–‹å§‹å§ï¼</div>
          </div>

          <div class="row" style="margin-top:14px;justify-content:space-between">
            <button class="btn2" id="prevBtn" disabled>â¬…ï¸ ä¸Šä¸€é¡Œ</button>
            <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€é¡Œ â¡ï¸</button>
          </div>
        </div>
      </section>

      <aside class="card side">
        <div class="hd"><b>ğŸ“Š æˆç¸¾å°é¢æ¿</b></div>
        <div class="bd">
          <div class="stat">
            <div class="box"><b id="statTotal">0</b><span>ç¸½é¡Œæ•¸</span></div>
            <div class="box"><b id="statAnswered">0</b><span>å·²ä½œç­”</span></div>
            <div class="box"><b id="statCorrect">0</b><span>ç­”å°</span></div>
            <div class="box"><b id="statAcc">0%</b><span>æ­£ç¢ºç‡</span></div>
            <div class="box" style="grid-column: 1 / -1;"><b id="statTime">--</b><span>æœ¬é¡Œå‰©é¤˜æ™‚é–“</span></div>
          </div>

          <div style="margin-top:14px">
            <div class="tiny" style="margin-bottom:6px">é€²åº¦æ¢</div>
            <div class="progress" aria-label="progress"><div class="bar" id="bar"></div></div>
          </div>

          <div style="margin-top:14px" class="muted">
            ğŸ’¡ å°å­¸è€…æç¤ºï¼š
            <ul style="margin:8px 0 0 18px; padding:0">
              <li>çœ‹å¥å­ï¼š<b>å‹•ä½œ</b> â†’ å¸¸ç”¨å‰¯è©ï¼›<b>çœ‹èµ·ä¾†/æ„Ÿè¦º</b> â†’ å¸¸ç”¨å½¢å®¹è©ã€‚</li>
              <li>ç­”å®Œæœƒé¡¯ç¤º âœ…/âŒï¼Œå†æŒ‰ã€Œä¸‹ä¸€é¡Œã€å°±å¥½ã€‚</li>
              <li>éµç›¤å¿«é€Ÿéµï¼š<span class="kbd">N</span> ä¸‹ä¸€é¡Œã€<span class="kbd">P</span> ä¸Šä¸€é¡Œã€‚</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      Made with ğŸŒˆ for young learners Â· æ”¯æ´é›¢ç·šä½¿ç”¨ï¼ˆå­˜æˆ .html ç›´æ¥é–‹ï¼‰
    </footer>

    <!-- å®Œæˆç•«é¢ï¼ˆéŠæˆ²æ„Ÿ âœ¨ï¼‰ -->
    <div class="overlay" id="finishOverlay" role="dialog" aria-modal="true" aria-label="å®Œæˆç•«é¢">
      <div class="modal">
        <div class="emojiRain" id="emojiRain" aria-hidden="true"></div>
        <div class="mh">
          <div>
            <div class="stars" id="finishStars">â­â­â­</div>
            <div class="big" id="finishTitle">ä»»å‹™å®Œæˆï¼</div>
          </div>
          <button class="btn2" id="finishCloseBtn" title="é—œé–‰">âœ–</button>
        </div>
        <div class="mb">
          <div class="sub" id="finishMsg">å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†å…¨éƒ¨é¡Œç›®ï½</div>
          <div class="grid2">
            <div class="chip"><b id="finishScore">0/0</b><span>ç­”å° / ç¸½é¡Œæ•¸</span></div>
            <div class="chip"><b id="finishAcc">0%</b><span>æ­£ç¢ºç‡</span></div>
            <div class="chip"><b id="finishMaxCombo">0</b><span>æœ€é«˜é€£å°</span></div>
            <div class="chip"><b id="finishTimeMode">--</b><span>è¨ˆæ™‚æ¨¡å¼</span></div>
          </div>
          <div class="row" style="margin-top:14px;justify-content:space-between">
            <button class="btn2" id="finishReviewBtn">ğŸ” çœ‹çµæœ</button>
            <button class="btn" id="finishPlayBtn">ğŸ”„ å†æŒ‘æˆ°ä¸€æ¬¡</button>
          </div>
          <div class="muted" style="margin-top:10px">æç¤ºï¼šå†æŒ‘æˆ°ä¸€æ¬¡æœƒé‡æ–°æ´—ç‰Œé¡Œç›®èˆ‡é¸é …å–”ï¼</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // å¯æ„›è‹±æ–‡å¡«ç©ºå°æ¸¬é©—ï¼ˆé€²éšç‰ˆï¼‰
  // âœ… éš¨æ©Ÿå‡ºé¡Œ âœ… æ‰“äº‚é¸é … âœ… å€’æ•¸è¨ˆæ™‚ âœ… æ¯é¡ŒéŸ³æ•ˆ âœ… å°å‹•ç•« âœ… é€£å° âœ… å®Œæˆç•«é¢
  // âœ… æ”¯æ´ 3 æˆ– 4 å€‹é¸é …ï¼ˆ3 é¸ 1 / 4 é¸ 1ï¼‰

  const $ = (sel) => document.querySelector(sel);

  const fileInput = $('#fileInput');
  const demoBtn = $('#demoBtn');
  const restartBtn = $('#restartBtn');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');

  const timeSelect = $('#timeSelect');
  const soundToggle = $('#soundToggle');
  const autoNextToggle = $('#autoNextToggle');

  const qNo = $('#qNo');
  const qText = $('#qText');
  const choicesEl = $('#choices');

  const dot = $('#dot');
  const fbText = $('#fbText');

  const statTotal = $('#statTotal');
  const statAnswered = $('#statAnswered');
  const statCorrect = $('#statCorrect');
  const statAcc = $('#statAcc');
  const statTime = $('#statTime');

  const pillProgress = $('#pillProgress');
  const pillCorrect = $('#pillCorrect');
  const pillCombo = $('#pillCombo');
  const pillMaxCombo = $('#pillMaxCombo');
  const pillTimer = $('#pillTimer');
  const bar = $('#bar');

  // finish overlay elements
  const finishOverlay = $('#finishOverlay');
  const finishCloseBtn = $('#finishCloseBtn');
  const finishReviewBtn = $('#finishReviewBtn');
  const finishPlayBtn = $('#finishPlayBtn');
  const finishStars = $('#finishStars');
  const finishTitle = $('#finishTitle');
  const finishMsg = $('#finishMsg');
  const finishScore = $('#finishScore');
  const finishAcc = $('#finishAcc');
  const finishMaxComboEl = $('#finishMaxCombo');
  const finishTimeMode = $('#finishTimeMode');
  const emojiRain = $('#emojiRain');

  let questions = []; // {text, options:[{label,isCorrect}], correctIndex}
  let idx = 0;
  let answered = []; // null or {chosenIndex, isCorrect, timedOut}
  let correctCount = 0;
  let combo = 0;
  let maxCombo = 0;
  let finishShown = false;

  // timer
  let timePerQ = 15; // 0 = off
  let remaining = 0;
  let timerId = null;

  // audio (WebAudio)
  let audioCtx = null;

  const DEMO_TEXT = `1.

The girl looks _____.
*happy, happily, happier, happiest

2.

The teacher spoke _____.
clear, *clearly, clearer, clearest

3.

John feels _____.
*tired, tiredly, more tired, tiredest

4.

The children played _____.
happy, *happily, happier, happiest

5.

She is a _____ dancer.
*good, well, better, best

6.

(3-choice demo) Yesterday, Tom _____ to school.
*went, goes, will go
`;

  // --- parsing helpers ---
  function stripWeirdChars(s){
    // handle BOM + non-breaking spaces + zero-width
    return String(s ?? '')
      .replace(/\uFEFF/g, '')
      .replace(/\u00A0/g, ' ')
      .replace(/[\u200B-\u200D\u2060]/g, '');
  }

  function normalizeLine(s){
    return stripWeirdChars(s).trim();
  }

  function looksLikeNumberingLine(line){
    const t = normalizeLine(line);
    if(!t) return false;
    return /^(?:#\d+|\(?\d+\)?[\.)]?)$/.test(t);
  }

  function parseQuizText(text){
    // Robust newline handling:
    // - \r\n (Windows), \n (Unix), \r (old Mac)
    const raw = stripWeirdChars(text);
    const lines = raw
      .split(/\r\n|\n|\r/g)
      .map(normalizeLine)
      .filter(l => l !== '');

    const out = [];
    for(let i=0; i<lines.length; i++){
      const line = lines[i];
      if(looksLikeNumberingLine(line)) continue;

      const qLine = line;
      const aLine = lines[i+1] ?? '';

      if(aLine.includes(',')){
        const parts = aLine.split(',').map(p => p.trim()).filter(Boolean);
        // âœ… æ”¯æ´ 3 æˆ– 4 é¸
        if(parts.length >= 3){
          const takeN = parts.length >= 4 ? 4 : 3;
          const picked = parts.slice(0, takeN);
          const options = picked.map(p => {
            const isCorrect = p.startsWith('*');
            return { label: isCorrect ? p.slice(1).trim() : p, isCorrect };
          });
          const correctIndex = options.findIndex(o => o.isCorrect);
          out.push({
            text: qLine,
            options,
            correctIndex: correctIndex >= 0 ? correctIndex : 0,
          });
          i++; // skip answer line
        }
      }
    }
    return out;
  }

  // --- randomization ---
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function shuffleQuestionAndOptions(q){
    const indexed = q.options.map((o, i) => ({...o, __i:i}));
    const sh = shuffle(indexed);
    const newCorrect = sh.findIndex(o => o.__i === q.correctIndex);
    return {
      text: q.text,
      options: sh.map(o => ({ label: o.label, isCorrect: o.isCorrect })),
      correctIndex: newCorrect >= 0 ? newCorrect : 0,
    };
  }

  // --- UI helpers ---
  function setFeedback(msg, kind){
    fbText.textContent = msg;
    dot.classList.remove('good','bad');
    if(kind === 'good') dot.classList.add('good');
    if(kind === 'bad') dot.classList.add('bad');
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function lettersFor(n){
    const base = ['A','B','C','D'];
    return base.slice(0, Math.max(0, Math.min(4, n)));
  }

  function setChoicesLayout(n){
    // 3/4 é¸ï¼šå…©æ¬„ï¼›2 é¸ï¼šä¸€æ¬„ï¼›1 é¸ï¼šä¸€æ¬„
    if(!choicesEl) return;
    if(n <= 2){
      choicesEl.style.gridTemplateColumns = '1fr';
    }else{
      choicesEl.style.gridTemplateColumns = '1fr 1fr';
    }
  }

  // ---------- Audio ----------
  function ensureAudio(){
    if(!soundToggle.checked) return null;
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    return audioCtx;
  }

  function playTone(freq, duration=0.12, type='sine', gain=0.06){
    const ctx = ensureAudio();
    if(!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(ctx.destination);
    const t = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(gain, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + duration);
    o.start(t);
    o.stop(t + duration + 0.02);
  }

  function sfxCorrect(){ playTone(660, 0.10, 'triangle', 0.07); setTimeout(()=>playTone(880, 0.12, 'triangle', 0.07), 110); }
  function sfxWrong(){ playTone(220, 0.14, 'sawtooth', 0.05); setTimeout(()=>playTone(170, 0.18, 'sawtooth', 0.05), 130); }
  function sfxTick(){ playTone(520, 0.05, 'square', 0.03); }
  function sfxTimeUp(){ playTone(300, 0.14, 'sine', 0.06); setTimeout(()=>playTone(260, 0.18, 'sine', 0.06), 140); }
  function sfxFinish(){
    playTone(523.25, 0.10, 'triangle', 0.07);
    setTimeout(()=>playTone(659.25, 0.10, 'triangle', 0.07), 110);
    setTimeout(()=>playTone(783.99, 0.14, 'triangle', 0.08), 220);
  }

  // ---------- Timer ----------
  function stopTimer(){
    if(timerId){ clearInterval(timerId); timerId = null; }
  }

  function updateTimerUI(){
    if(timePerQ <= 0){
      statTime.textContent = 'ä¸è¨ˆæ™‚';
      pillTimer.textContent = 'é—œ';
      return;
    }
    statTime.textContent = `${remaining} ç§’`;
    pillTimer.textContent = `${remaining}s`;
  }

  function startTimerIfNeeded(){
    stopTimer();
    if(questions.length === 0) return;
    if(timePerQ <= 0){ remaining = 0; updateTimerUI(); return; }
    if(answered[idx] !== null){ remaining = 0; updateTimerUI(); return; }

    remaining = timePerQ;
    updateTimerUI();

    timerId = setInterval(() => {
      remaining--;
      if(remaining <= 5 && remaining > 0) sfxTick();
      if(remaining <= 0){
        stopTimer();
        onTimeUp();
        return;
      }
      updateTimerUI();
    }, 1000);
  }

  function onTimeUp(){
    if(answered[idx] !== null) return;
    answered[idx] = { chosenIndex: -1, isCorrect: false, timedOut: true };

    combo = 0;
    sfxTimeUp();

    const main = document.querySelector('.card.main');
    main?.classList.remove('shake');
    void main?.offsetWidth;
    main?.classList.add('shake');

    const q = questions[idx];
    const correctText = q.options[q.correctIndex]?.label ?? '(ç­”æ¡ˆ)';
    setFeedback(`æ™‚é–“åˆ° â° æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctText}`, 'bad');

    renderChoicesLocked();
    updateStats();
    checkFinish();

    if(autoNextToggle.checked){
      setTimeout(() => {
        if(idx < questions.length - 1){ idx++; render(); }
      }, 650);
    }
  }

  // ---------- Render ----------
  function updateStats(){
    const total = questions.length;
    const answeredCount = answered.filter(x => x !== null).length;
    const acc = answeredCount === 0 ? 0 : Math.round((correctCount / answeredCount) * 100);

    statTotal.textContent = String(total);
    statAnswered.textContent = String(answeredCount);
    statCorrect.textContent = String(correctCount);
    statAcc.textContent = `${acc}%`;

    pillProgress.textContent = `${Math.min(idx+1, total)}/${total}`;
    pillCorrect.textContent = String(correctCount);
    pillCombo.textContent = String(combo);
    pillMaxCombo.textContent = String(maxCombo);

    const progress = total === 0 ? 0 : Math.round((answeredCount / total) * 100);
    bar.style.width = `${progress}%`;

    restartBtn.disabled = total === 0;
    prevBtn.disabled = total === 0 || idx === 0;
    nextBtn.disabled = total === 0 || idx >= total - 1;

    updateTimerUI();
  }

  function renderChoicesLocked(){
    const q = questions[idx];
    const letters = lettersFor(q.options.length);
    setChoicesLayout(q.options.length);
    choicesEl.innerHTML = '';

    q.options.forEach((opt, k) => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.type = 'button';
      btn.disabled = true;
      btn.innerHTML = `<span class="badge">${letters[k] ?? ''}</span><span>${escapeHtml(opt.label)}</span>`;

      const ans = answered[idx];
      if(k === q.correctIndex) btn.classList.add('correct');
      if(ans && k === ans.chosenIndex && !ans.isCorrect) btn.classList.add('wrong');

      choicesEl.appendChild(btn);
    });
  }

  function render(){
    stopTimer();

    if(questions.length === 0){
      qNo.textContent = 'å°šæœªè¼‰å…¥é¡Œç›®';
      qText.textContent = 'è«‹å…ˆé¸æ“‡ä¸€å€‹ .txt é¡Œç›®æª”ï¼Œæˆ–æŒ‰ã€Œè¼‰å…¥ç¤ºç¯„ã€ã€‚';
      choicesEl.innerHTML = '';
      updateStats();
      return;
    }

    const q = questions[idx];
    qNo.textContent = `ç¬¬ ${idx+1} é¡Œ / å…± ${questions.length} é¡Œ`;
    qText.textContent = q.text;

    qText.classList.remove('pop');
    void qText.offsetWidth;
    qText.classList.add('pop');

    const letters = lettersFor(q.options.length);
    setChoicesLayout(q.options.length);
    choicesEl.innerHTML = '';

    q.options.forEach((opt, k) => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.type = 'button';
      btn.innerHTML = `<span class="badge">${letters[k] ?? ''}</span><span>${escapeHtml(opt.label)}</span>`;

      const ans = answered[idx];
      if(ans){
        btn.disabled = true;
        if(k === q.correctIndex) btn.classList.add('correct');
        if(k === ans.chosenIndex && !ans.isCorrect) btn.classList.add('wrong');
      }

      btn.addEventListener('click', () => choose(k));
      choicesEl.appendChild(btn);
    });

    const ans = answered[idx];
    if(ans){
      if(ans.isCorrect){
        setFeedback('ç­”å°äº†ï¼ä½ å¤ªå²å®³äº† ğŸ¥³', 'good');
      }else if(ans.timedOut){
        const correctText = q.options[q.correctIndex]?.label ?? '(ç­”æ¡ˆ)';
        setFeedback(`æ™‚é–“åˆ° â° æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctText}`, 'bad');
      }else{
        const correctText = q.options[q.correctIndex]?.label ?? '(ç­”æ¡ˆ)';
        setFeedback(`å·®ä¸€é»ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctText} ğŸ™‚`, 'bad');
      }
      renderChoicesLocked();
    }else{
      setFeedback('è«‹é»é¸ä½ è¦ºå¾—æ­£ç¢ºçš„é¸é …ï½', 'neutral');
    }

    updateStats();
    startTimerIfNeeded();

    const main = document.querySelector('.card.main');
    if(ans) main?.classList.remove('glow');
    else main?.classList.add('glow');
  }

  function lockAfterAnswer(){
    stopTimer();
    renderChoicesLocked();
    updateStats();

    if(autoNextToggle.checked){
      setTimeout(() => {
        if(idx < questions.length - 1){ idx++; render(); }
      }, 650);
    }
  }

  function choose(k){
    if(answered[idx] !== null) return;

    const q = questions[idx];
    const isCorrect = (k === q.correctIndex);
    answered[idx] = { chosenIndex: k, isCorrect, timedOut: false };

    if(isCorrect){
      correctCount++;
      combo++;
      if(combo > maxCombo) maxCombo = combo;
    }else{
      combo = 0;
    }

    const main = document.querySelector('.card.main');
    main?.classList.remove('pop','shake');
    void main?.offsetWidth;

    if(isCorrect){
      sfxCorrect();
      main?.classList.add('pop');
      setFeedback(combo >= 3 ? `ç­”å°äº†ï¼ğŸ”¥ é€£å° ${combo} é¡Œï¼` : 'ç­”å°äº†ï¼ä½ å¤ªå²å®³äº† ğŸ¥³', 'good');
    }else{
      sfxWrong();
      main?.classList.add('shake');
      const correctText = q.options[q.correctIndex]?.label ?? '(ç­”æ¡ˆ)';
      setFeedback(`å·®ä¸€é»ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correctText} ğŸ™‚`, 'bad');
    }

    lockAfterAnswer();
    checkFinish();
  }

  function resetState(){
    // ğŸ”€ æ¯æ¬¡é‡æ–°é–‹å§‹éƒ½é‡æ–°æ´—ç‰Œé¡Œç›®é †åºï¼ˆé¿å…çœ‹èµ·ä¾†æ²’äº‚ï¼‰
    questions = shuffle(questions).map(shuffleQuestionAndOptions);
    idx = 0;
    answered = Array.from({ length: questions.length }, () => null);
    correctCount = 0;
    combo = 0;
    maxCombo = 0;
    finishShown = false;
    hideFinish();
    setFeedback('æº–å‚™å¥½äº†å°±é–‹å§‹å§ï¼', 'neutral');
    updateStats();
    render();
  }

  function loadText(text){
    const parsed = parseQuizText(text);
    if(parsed.length === 0){
      alert([
        'è®€ä¸åˆ°é¡Œç›® ğŸ˜¿',
        '',
        'è«‹æª¢æŸ¥æ–‡å­—æª”æ ¼å¼ï¼š',
        '- é¡Œç›®ä¸€è¡Œ',
        '- ä¸‹ä¸€è¡Œ 3ï½4 å€‹é¸é …ç”¨é€—è™Ÿåˆ†éš”',
        '- æ­£ç¢ºç­”æ¡ˆå‰åŠ  *',
      ].join('\n'));
      return;
    }

    // âœ… éš¨æ©Ÿå‡ºé¡Œï¼ˆæ´—ç‰Œé¡Œç›®ï¼‰ + âœ… æ‰“äº‚é¸é …
    questions = shuffle(parsed).map(shuffleQuestionAndOptions);
    resetState();
  }

  // ---------- Self tests (console) ----------
  function runSelfTests(){
    const cases = [
      {
        name: 'DEMO_TEXT basic',
        input: DEMO_TEXT,
        expectMin: 6,
      },
      {
        name: 'Windows CRLF + BOM',
        input: '\uFEFFThe girl looks _____.\r\n*happy, happily, happier, happiest\r\n\r\nThe teacher spoke _____.\r\nclear, *clearly, clearer, clearest\r\n',
        expectMin: 2,
      },
      {
        name: 'Weird invisible chars',
        input: 'The boy runs _____.\u200B\nfast, *fast, faster, fastest\n',
        expectMin: 1,
      },
      {
        name: 'Numbering lines are ignored',
        input: '1.\n\nTom runs _____.\n*faster, more fast, fastly, more faster\n\n2)\nShe speaks _____.\n*more slowly, slowlier, slowerly, slowest\n',
        expectMin: 2,
      },
      {
        name: '3-choice is supported',
        input: 'Yesterday, Tom _____ to school.\n*went, goes, will go\n',
        expectMin: 1,
      },
    ];

    let ok = true;
    for(const tc of cases){
      const got = parseQuizText(tc.input);
      if(!(got.length >= tc.expectMin)){
        ok = false;
        console.error('[SelfTest FAIL]', tc.name, {gotLen: got.length, got});
      }else{
        console.log('[SelfTest OK]', tc.name, got.length);
      }
    }
    return ok;
  }

  function calcStars(acc){
    if(acc >= 90) return 5;
    if(acc >= 75) return 4;
    if(acc >= 60) return 3;
    if(acc >= 40) return 2;
    return 1;
  }

  function timeModeLabel(){
    if(timePerQ <= 0) return 'ä¸è¨ˆæ™‚';
    return `${timePerQ} ç§’/é¡Œ`;
  }

  function makeEmojiRain(){
    if(!emojiRain) return;
    emojiRain.innerHTML = '';
    const emojis = ['âœ¨','ğŸŒˆ','ğŸ‰','â­','ğŸ§','ğŸ­','ğŸ’–'];
    const count = 26;
    for(let i=0; i<count; i++){
      const s = document.createElement('span');
      s.className = 'emoji';
      s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      s.style.left = `${Math.random()*100}%`;
      s.style.animationDuration = `${1.2 + Math.random()*1.2}s`;
      s.style.fontSize = `${18 + Math.random()*10}px`;
      s.style.opacity = `${0.75 + Math.random()*0.25}`;
      s.style.transform = `translateY(-20px) rotate(${Math.random()*120}deg)`;
      emojiRain.appendChild(s);
    }
  }

  function showFinish(){
    if(!finishOverlay) return;
    stopTimer();

    const total = questions.length;
    const answeredCount = answered.filter(x => x !== null).length;
    const acc = answeredCount === 0 ? 0 : Math.round((correctCount / answeredCount) * 100);

    const stars = 'â­'.repeat(calcStars(acc));
    finishStars.textContent = stars;

    finishTitle.textContent = acc >= 80 ? 'è¶…æ£’é€šé—œï¼' : (acc >= 60 ? 'å®Œæˆä»»å‹™ï¼' : 'å®ŒæˆæŒ‘æˆ°ï¼');
    finishMsg.textContent = 'ä½ å®Œæˆäº†å…¨éƒ¨é¡Œç›®ï½å»è·Ÿè€å¸«æ“ŠæŒä¸€ä¸‹ ğŸ–ï¸';

    finishScore.textContent = `${correctCount}/${total}`;
    finishAcc.textContent = `${acc}%`;
    finishMaxComboEl.textContent = String(maxCombo);
    finishTimeMode.textContent = timeModeLabel();

    makeEmojiRain();

    finishOverlay.classList.add('show');
    finishShown = true;
    sfxFinish();
  }

  function hideFinish(){
    finishOverlay?.classList.remove('show');
    emojiRain && (emojiRain.innerHTML = '');
  }

  function checkFinish(){
    const total = questions.length;
    if(total === 0) return;
    const answeredCount = answered.filter(x => x !== null).length;
    if(answeredCount === total && !finishShown){
      showFinish();
    }
  }

  // ---------- Events ----------
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    loadText(text);
  });

  demoBtn.addEventListener('click', () => loadText(DEMO_TEXT));
  restartBtn.addEventListener('click', () => resetState());

  finishCloseBtn?.addEventListener('click', () => hideFinish());
  finishReviewBtn?.addEventListener('click', () => hideFinish());
  finishPlayBtn?.addEventListener('click', () => {
    hideFinish();
    resetState();
  });

  // é»èƒŒæ™¯ä¹Ÿå¯é—œé–‰
  finishOverlay?.addEventListener('click', (e) => {
    if(e.target === finishOverlay) hideFinish();
  });

  prevBtn.addEventListener('click', () => { if(idx > 0){ idx--; render(); } });
  nextBtn.addEventListener('click', () => { if(idx < questions.length - 1){ idx++; render(); } });

  timeSelect.addEventListener('change', () => {
    timePerQ = parseInt(timeSelect.value, 10) || 0;
    render();
  });

  document.addEventListener('keydown', (e) => {
    if(questions.length === 0) return;
    if(e.key === 'n' || e.key === 'N'){
      if(idx < questions.length - 1){ idx++; render(); }
    }
    if(e.key === 'p' || e.key === 'P'){
      if(idx > 0){ idx--; render(); }
    }
  });

  // Run tests early (no UI impact)
  runSelfTests();
</script>
</body>
</html>

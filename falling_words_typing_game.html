<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Falling Words — Typing Practice</title>
  <style>
    :root{
      --bg:#0f172a; --bg-2:#1e293b; --panel:#334155; --ink:#e2e8f0;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --bubble:#6366f1; --typed:#22d3ee;
    }
    html,body{height:100%;margin:0;background:var(--bg-2);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    h1{margin:16px 0;text-align:center;font-weight:800}
    .bar{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center}
    .btn{border:0;border-radius:16px;padding:10px 14px;font-weight:700;color:#fff;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.2)}
    .btn.start{background:var(--ok)}
    .btn.pause{background:var(--warn)}
    .btn.reset{background:var(--panel)}
    .chip{display:flex;gap:8px;align-items:center;background:var(--panel);padding:8px 12px;border-radius:16px}
    select{background:var(--bg);color:var(--ink);border-radius:10px;padding:6px 8px;border:1px solid #475569}
    .hud{display:flex;gap:16px;align-items:center;background:var(--panel);padding:8px 14px;border-radius:16px}
    .val{font-weight:800}
    .stage{position:relative;max-width:960px;height:600px;margin:16px auto;border-radius:20px;background:var(--bg);overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.35)}
    .ground{position:absolute;left:0;right:0;bottom:0;height:3px;background:#475569}
    .word{position:absolute;user-select:none;font-weight:900;font-size:28px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.5)); white-space:nowrap}
    .bubble{display:inline-block;padding:6px 12px;border-radius:16px;background:rgba(99,102,241,.9);backdrop-filter:saturate(1.2) blur(2px); white-space:nowrap}
    .typed{color:var(--typed)}
    .center{position:absolute;inset:0;display:grid;place-items:center;text-align:center;padding:16px}
    .panel{background:rgba(30,41,59,.9);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .kbd{display:inline-block;background:#0b1220;border-radius:6px;padding:2px 6px;border:1px solid #263142}
    .tips{max-width:960px;margin:8px auto 24px;padding:0 12px;opacity:.9}
    .tips ul{margin:8px 0 0 1.2em}
    .filehint{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <h1>Falling Words — Typing Practice</h1>

  <div class="bar">
    <button id="startBtn" class="btn start">Start (Space)</button>
    <button id="resetBtn" class="btn reset">Reset</button>
    <button id="importBtn" class="btn reset">Import TXT</button>
    <input id="importTxt" type="file" accept=".txt,text/plain" hidden />

    <div class="chip">
      <span>Difficulty</span>
      <select id="diffSel">
        <option>Easy</option>
        <option selected>Normal</option>
        <option>Hard</option>
        <option>Insane</option>
      </select>
    </div>

    <div class="hud">
      <div>Score <span id="score" class="val">0</span></div>
      <div>Combo <span id="combo" class="val">0x</span></div>
      <div>Lives <span id="lives" class="val">5</span></div>
      <div>Best <span id="best" class="val">0</span></div>
    </div>
  </div>

  <div id="stage" class="stage" tabindex="0" aria-label="game stage" aria-live="polite">
    <div class="ground"></div>
    <div id="overlay" class="center"></div>
  </div>

  <div class="tips">
    <h3>How to Play</h3>
    <ul>
      <li>按下 Start 後，會有英文單詞從上方掉落；請依序輸入該單詞的字母。</li>
      <li>可上傳 <b>純文字檔（每行一個單字）</b> 作為詞庫；若未上傳則使用內建詞庫。</li>
      <li>輸入正確字母會高亮前綴；完成整個單詞即消除並得分。打錯會清空連擊並小扣分。</li>
      <li>字詞落地會扣 1 命，共 5 命。</li>
      <li>難度與單詞長度上限：Easy/Normal ≤5、Hard ≤8、Insane ≤12。</li>
    </ul>
    <div class="filehint">檔案格式：UTF-8 文字檔，每行一個只含英文字母 a–z 的單字（自動轉小寫；重複與含非字母的將被忽略）。</div>
  </div>

  <script>
    (()=>{
      // ===== Built-in word bank (fallback) =====
      const WORDS = {
        2: ["am","an","as","at","be","by","do","go","he","hi","if","in","is","it","me","my","no","of","on","or","so","to","up","us","we","ox","pi","tv","id","ok"],
        3: ["and","ant","any","art","ask","bad","bag","bar","bed","big","box","boy","bus","cat","cow","cut","day","dog","egg","far","fix","fun","get","hat","hot","jam","map","pen","pig","sun"],
        4: ["able","also","area","bank","base","bear","blue","book","camp","card","city","cook","cool","door","east","fast","fish","food","free","game","girl","hand","home","idea","join","kind","lake","love","nice","time"],
        5: ["about","ahead","apple","basic","black","brain","break","bring","build","carry","catch","chair","class","clean","close","color","dance","earth","faith","ghost","happy","heart","light","magic","money","music","plant","quick","river","smart"],
        6: ["animal","answer","arrive","basket","beauty","better","bottle","bridge","bright","butter","camera","candle","castle","choose","circle","danger","decide","doctor","family","father","flower","friend","future","golden","health","island","little","mother","nature","people"],
        7: ["ability","another","balance","because","between","billion","cabinet","captain","central","college","country","culture","dancing","deliver","diamond","drawing","economic","emotion","evening","forest","freedom","general","history","journey","library","machine","morning","natural","picture","problem"],
        8: ["absolute","accurate","activity","airplane","american","analysis","anything","audience","birthday","business","butterfly","capacity","carefully","category","children","complete","computer","creative","decision","daughter","distance","education","elephant","exercise","favorite","festival","football","friendly","graduate","hospital"],
        9: ["adventure","attention","beautiful","challenge","chocolate","community","container","different","direction","discovery","education","efficient","engineer","excellent","favourite","happiness","important","incredible","language","mountains","newspaper","passenger","photograph","pineapple","principal","prototype","secretary","signature","strawberry","telephone"],
        10:["atmosphere","background","basketball","blueprint","chemistry","conference","courageous","dictionary","innovation","leadership","motorcycle","networking","physician","playground","population","recreation","restaurant","scientific","technology","watermelon","appearance","foundation","membership","operations","permission","reflection","republican","television","understand","volleyball"],
        11:["architecture","announcement","appointment","capability","celebration","championship","composition","consumption","cooperation","experience","imagination","independent","information","instruction","temperature","translation","university","vegetables","watercourse","wilderness","relationship","revolution","misfortune","development","possibility","electricity","microbiology","mathematics","determining","programming"],
        12:["administration","characteristic","communication","comprehensive","configuration","consideration","contribution","determination","entertainment","environmental","experimentation","identification","instrumentalist","international","misunderstand","opportunity","organizational","photographer","professional","recommendation","representative","responsibility","satisfaction","scientifically","transportation","underestimate","undergraduate","untraditional","vulnerability","weatherization"]
      };

      // ===== Difficulty → allowed max length =====
      const DIFF_LIMIT = { Easy:5, Normal:5, Hard:8, Insane:12 };

      // ===== Game state =====
      const elStage = document.getElementById('stage');
      const elOverlay = document.getElementById('overlay');
      const elStart = document.getElementById('startBtn');
      const elReset = document.getElementById('resetBtn');
      const elImport = document.getElementById('importTxt');
      const btnImport = document.getElementById('importBtn');
      const elDiff  = document.getElementById('diffSel');
      const vScore = document.getElementById('score');
      const vCombo = document.getElementById('combo');
      const vLives = document.getElementById('lives');
      const vBest  = document.getElementById('best');

      let running=false, over=false; let score=0, combo=0, lives=5, best=0;
      let words=[]; // {id,x,y,v,text,idx,el}
      let idSeq=1; let lastSpawn=0; let lastTick=0; let raf=0;
      let customBank=null; // { length: [words] }

      const presets = {
        Easy:   { spawnEveryMs: 1000, baseSpeed: 55, gravity: 9,  maxConcurrent: 6 },
        Normal: { spawnEveryMs: 850,  baseSpeed: 70, gravity: 12, maxConcurrent: 8 },
        Hard:   { spawnEveryMs: 700,  baseSpeed: 95, gravity: 16, maxConcurrent: 10 },
        Insane: { spawnEveryMs: 520,  baseSpeed: 120,gravity: 22, maxConcurrent: 12 },
      };
      let settings = { ...presets[elDiff.value] };

      function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
      function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

      function getActiveBank(){
        if (customBank && Object.keys(customBank).length) return customBank;
        return WORDS;
      }
      function availableLengths(bank, maxLen){
        return Object.keys(bank).map(Number).filter(L => L>=1 && L<=maxLen && bank[L] && bank[L].length>0);
      }
      function pickWord(maxLen){
        let bank = getActiveBank();
        let lens = availableLengths(bank, maxLen);
        if (!lens.length){ bank = WORDS; lens = availableLengths(bank, maxLen); }
        const L = randChoice(lens);
        return randChoice(bank[L]).toLowerCase();
      }

      // --- WebAudio SFX ---
      let AC; function ctx(){ return AC ||= new (window.AudioContext||window.webkitAudioContext)(); }
      function tone({type='sine', f=440, t=0.12, g=0.15, slide=0}){
        const a = ctx(); const now=a.currentTime; const o=a.createOscillator(); const v=a.createGain();
        o.type=type; o.frequency.setValueAtTime(f, now);
        if (slide) o.frequency.linearRampToValueAtTime(f+slide, now+t*0.8);
        v.gain.setValueAtTime(0, now); v.gain.linearRampToValueAtTime(g, now+0.01); v.gain.exponentialRampToValueAtTime(0.0001, now+t);
        o.connect(v); v.connect(a.destination); o.start(); o.stop(now+t+0.02);
      }
      function sfxGood(){ tone({type:'sine', f:520, t:0.10, g:0.18, slide:120}); }
      function sfxBad(){ tone({type:'square', f:220, t:0.12, g:0.18, slide:-80}); }

      function setHUD(){ vScore.textContent=score; vCombo.textContent=combo+'x'; vLives.textContent=lives; vBest.textContent=best; }
      function setStartBtn(){ elStart.textContent = running? 'Pause (Space)' : 'Start (Space)'; elStart.classList.toggle('pause', running); elStart.classList.toggle('start', !running); }

      function reset(){
        running=false; over=false; score=0; combo=0; lives=5; words=[]; idSeq=1; lastSpawn=0; lastTick=0;
        setHUD(); setStartBtn(); elDiff.disabled=false; elOverlay.innerHTML = hintHTML();
        document.querySelectorAll('.word').forEach(n=>n.remove());
      }

      function hintHTML(){
        return `<div class="panel">
          <p>Press <span class="kbd">Start</span> to begin.</p>
          <p style="opacity:.8;margin-top:6px">Type each falling <b>word</b> in order. Finish a word to clear it!</p>
        </div>`;
      }

      function gameOver(){
        over=true; running=false; best=Math.max(best, score); setHUD(); setStartBtn(); elDiff.disabled=false;
        elOverlay.innerHTML = `<div class="panel">
          <h2 style="margin:0 0 8px 0">Game Over</h2>
          <p>Score: <b>${score}</b></p>
          <p>Best: <b>${best}</b></p>
          <div style="margin-top:10px"><button class="btn start" id="againBtn">Play Again</button></div>
          <p style="opacity:.6;font-size:12px;margin-top:8px">Tip: Aim for long combo streaks!</p>
        </div>`;
        document.getElementById('againBtn').onclick = reset;
      }

      function renderWordEl(text, idx){
        const typed = text.slice(0, idx);
        const rest = text.slice(idx);
        return `<span class="bubble"><span class="typed">${typed}</span>${rest}</span>`;
      }

      function spawn(){
        const rect = elStage.getBoundingClientRect();
        const width = rect.width; const margin = 24;
        if (words.length >= settings.maxConcurrent) return;

        const el = document.createElement('span');
        el.className = 'word';
        const text = pickWord(DIFF_LIMIT[elDiff.value]);
        el.innerHTML = renderWordEl(text, 0);
        elStage.appendChild(el);

        // --- Overflow fix: ensure entire word fits horizontally ---
        const maxContentWidth = width - margin*2;
        // Measure and shrink font-size if necessary
        const baseFont = 28; // px
        let w = el.getBoundingClientRect().width;
        if (w > maxContentWidth){
          const scale = Math.max(16, Math.floor(baseFont * (maxContentWidth / w))); // clamp >=16px
          el.style.fontSize = scale + 'px';
          w = el.getBoundingClientRect().width; // re-measure after shrink
        }
        // Now choose x so that [x, x+w] fully inside stage
        const minX = margin;
        const maxX = Math.max(minX, width - margin - w);
        const x = clamp(Math.random()*(maxX - minX) + minX, minX, maxX);

        const word = { id:idSeq++, x, y:-28, v: settings.baseSpeed*(0.85+Math.random()*0.3), text, idx:0, el };
        words.push(word);
        el.style.transform = `translate(${Math.round(x)}px, -28px)`;
      }

      function tick(t){
        if (!running) return; if (!lastTick) lastTick=t; const dt=(t-lastTick)/1000; lastTick=t;
        // spawn
        if (!lastSpawn) lastSpawn=t; if (t-lastSpawn>=settings.spawnEveryMs){ lastSpawn=t; spawn(); }
        const height = elStage.getBoundingClientRect().height;
        const remain=[]; let lost=0;
        for (const W of words){
          W.v += settings.gravity * 60 * dt * 0.016; // gentle accel
          W.y += W.v * dt;
          if (W.y >= height - 40){ lost++; W.el.remove(); } else { remain.push(W); W.el.style.transform = `translate(${Math.round(W.x)}px, ${Math.round(W.y)}px)`; }
        }
        words = remain;
        if (lost>0){ lives -= lost; combo=0; score = Math.max(0, score - lost); sfxBad(); setHUD(); if (lives<=0) return gameOver(); }
        raf = requestAnimationFrame(tick);
      }

      function startPause(){ if (over) return; running=!running; setStartBtn(); elOverlay.innerHTML=''; if (running){ elDiff.disabled=true; raf=requestAnimationFrame(tick);} }

      // input
      function onKey(e){
        if (e.code==='Space'){ e.preventDefault(); startPause(); return; }
        if (!running || over) return;
        const k = e.key.toLowerCase(); if (k.length!==1 || !/[a-z]/.test(k)) return;
        if (!words.length) return;
        const can = words.filter(W=>W.text[W.idx]===k);
        if (!can.length){ combo=0; score=Math.max(0, score-1); sfxBad(); return setHUD(); }
        let target = can[0]; for (const w of can){ if (w.y > target.y) target = w; }
        target.idx += 1;
        if (target.idx >= target.text.length){
          words = words.filter(w=>w.id!==target.id);
          target.el.remove();
          combo += 1; score += 15 + Math.min(60, combo*3); sfxGood(); setHUD();
          if (words.length < Math.max(4, Math.floor(settings.maxConcurrent*0.5)) && Math.random()<0.25) spawn();
        } else {
          target.el.innerHTML = renderWordEl(target.text, target.idx);
          score += 1; setHUD();
        }
      }

      // Import TXT word list
      btnImport.addEventListener('click', ()=> elImport.click());
      elImport.addEventListener('change', async (e)=>{
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          const text = await file.text();
          const lines = text.split(/\r?\n/);
          const bank = {};
          for (let raw of lines){
            if (!raw) continue;
            const w = raw.trim().toLowerCase();
            if (!w || !/^[a-z]+$/.test(w)) continue; // keep alphabetic only
            const L = w.length;
            (bank[L] ||= []);
            if (!bank[L].includes(w)) bank[L].push(w);
          }
          customBank = bank;
          // small toast in overlay
          const kinds = Object.keys(bank).length;
          const total = Object.values(bank).reduce((a,b)=>a+b.length,0);
          elOverlay.innerHTML = `<div class="panel"><b>Loaded custom list</b><br>${total} words across ${kinds} lengths.</div>`;
          setTimeout(()=>{ if (!running) elOverlay.innerHTML = hintHTML(); else elOverlay.innerHTML=''; }, 1500);
        }catch(err){
          console.error(err);
          elOverlay.innerHTML = `<div class="panel">Failed to load file.</div>`;
          setTimeout(()=>{ if (!running) elOverlay.innerHTML = hintHTML(); else elOverlay.innerHTML=''; }, 1500);
        }
      });

      document.addEventListener('visibilitychange', ()=>{ if (document.hidden){ running=false; setStartBtn(); }});
      elStart.addEventListener('click', startPause);
      elReset.addEventListener('click', reset);
      elDiff.addEventListener('change', ()=>{ settings={...presets[elDiff.value]}; });
      window.addEventListener('keydown', onKey);

      reset();
    })();
  </script>
</body>
</html>
